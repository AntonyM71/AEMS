trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: Python
    displayName: "Python Build & Test"
    steps:
      - script: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv venv
          uv sync --dev
        displayName: "Setup Python Environment"
        workingDirectory: $(Build.SourcesDirectory)/Server
      - script: |
          ruff check .
        displayName: "Run Python Tests"
        workingDirectory: $(Build.SourcesDirectory)/Server
        continueOnError: true
      - script: |
          uv run python -m pytest --junitxml=pytest-results.xml
        displayName: "Run Python Tests"
        workingDirectory: $(Build.SourcesDirectory)/Server
        continueOnError: true

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "$(Build.SourcesDirectory)/Server/pytest-results.xml"
          failTaskOnFailedTests: true
        displayName: "Publish Python Test Results"

  - job: NodeJS
    displayName: "Node.js Build & Test"
    steps:
      - script: |
          npm ci
        displayName: "Install Node.js Dependencies"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm run tsc
        displayName: "Run TypeScript Compiler"
        workingDirectory: $(Build.SourcesDirectory)/Webapp
        continueOnError: true

      - script: |
          npm run lint"
        displayName: "Run Node.js Lint"
        workingDirectory: $(Build.SourcesDirectory)/Webapp
        continueOnError: true

      - script: |
          npm test -- --reporters="jest-junit" --outputFile="junit.xml"
        displayName: "Run Node.js Tests"
        workingDirectory: $(Build.SourcesDirectory)/Webapp
        continueOnError: true

      - script: |
          npm run build
        displayName: "Build Node.js Project"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "$(Build.SourcesDirectory)/Webapp/junit.xml"
          failTaskOnFailedTests: true
        displayName: "Publish Node.js Test Results"
