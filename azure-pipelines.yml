trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: Python
    displayName: "Python Build & Test"
    steps:
      - script: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv venv
          uv sync --dev
        displayName: "Setup Python Environment"
        workingDirectory: $(Build.SourcesDirectory)/Server
      - script: |
          uv run ruff check .
        displayName: "Run Python Linting"
        workingDirectory: $(Build.SourcesDirectory)/Server
      - script: |
          uv run python -m pytest --junitxml=pytest-results.xml
        displayName: "Run Python Tests"
        workingDirectory: $(Build.SourcesDirectory)/Server

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "$(Build.SourcesDirectory)/Server/pytest-results.xml"
          failTaskOnFailedTests: true
        displayName: "Publish Python Test Results"
        condition: succeededOrFailed()

  - job: NodeJS
    displayName: "Node.js Build & Test"
    steps:
      - script: |
          npm ci
        displayName: "Install Node.js Dependencies"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm run tsc
        displayName: "Run TypeScript Compiler"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm run lint
        displayName: "Run Node.js Lint"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm test -- --reporters="jest-junit" --outputFile="junit.xml"
        displayName: "Run Node.js Tests"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm run build
        displayName: "Build Node.js Project"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "$(Build.SourcesDirectory)/Webapp/junit.xml"
          failTaskOnFailedTests: true
        displayName: "Publish Node.js Test Results"
        condition: succeededOrFailed()

  - job: E2ETests
    displayName: "E2E Playwright Tests"
    steps:
      - script: |
          docker run -d --name postgres-e2e \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=postgres \
            -p 5432:5432 \
            postgres:16
          for i in $(seq 1 30); do
            docker exec postgres-e2e pg_isready -U postgres && break || sleep 2
          done
        displayName: "Start PostgreSQL"

      - script: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv venv
          uv sync
        displayName: "Setup Python Environment"
        workingDirectory: $(Build.SourcesDirectory)/Server

      - script: |
          CONNECTION_STRING=postgresql://postgres:postgres@localhost:5432/postgres \
            $(Build.SourcesDirectory)/Server/.venv/bin/alembic upgrade head
          CONNECTION_STRING=postgresql://postgres:postgres@localhost:5432/postgres \
            $(Build.SourcesDirectory)/Server/.venv/bin/python -m scripts.seed_scoresheets
        displayName: "Setup Database"
        workingDirectory: $(Build.SourcesDirectory)/Server

      - script: |
          CONNECTION_STRING=postgresql://postgres:postgres@localhost:5432/postgres \
            $(Build.SourcesDirectory)/Server/.venv/bin/uvicorn main:app \
            --host 0.0.0.0 --port 8000 --log-level warning &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && break || sleep 2
          done
        displayName: "Start Backend"
        workingDirectory: $(Build.SourcesDirectory)/Server

      - script: |
          npm ci
        displayName: "Install Frontend Dependencies"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          NEXT_PUBLIC_API_URL_DEV=http://localhost:8000/ npm start &
          for i in $(seq 1 30); do
            curl -sf http://localhost:3000 > /dev/null && break || sleep 3
          done
        displayName: "Start Frontend"
        workingDirectory: $(Build.SourcesDirectory)/Webapp

      - script: |
          npm ci
          npx playwright install --with-deps chromium
        displayName: "Install Playwright"
        workingDirectory: $(Build.SourcesDirectory)/e2e

      - script: |
          FRONTEND_URL=http://localhost:3000 BACKEND_URL=http://localhost:8000 npx playwright test
        displayName: "Run E2E Tests"
        workingDirectory: $(Build.SourcesDirectory)/e2e

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: "JUnit"
          testResultsFiles: "$(Build.SourcesDirectory)/e2e/playwright-results.xml"
          failTaskOnFailedTests: true
        displayName: "Publish E2E Test Results"
        condition: succeededOrFailed()

      - script: |
          docker stop postgres-e2e && docker rm postgres-e2e
        displayName: "Stop Services"
        condition: always()
